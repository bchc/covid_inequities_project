---
banner: img/banners/banner-mask.jpg
title: Dynata Mask-Wearing Survey Analysis for BCHC Cities
author: Ran Li
date: '2020-08-18'
output:
  blogdown::html_page:
    toc: true
slug: dynata-mask-wearing-survey-analysis-for-bchc-cities
categories:
  - preliminary analysis
tags:
  - mask
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# NYT data: https://github.com/nytimes/covid-19-data/tree/master/mask-use
# NYT article: https://www.nytimes.com/interactive/2020/07/17/upshot/coronavirus-face-mask-map.html

library(data.table)
library(tidyverse)
library(sf)
library(janitor)
library(htmltools)
library(lubridate)
library(broom)
library(leaflet)
library(readxl)
library(cowplot)
library(ggthemes)


## Load COVID Data
xwalk_url = "https://raw.githubusercontent.com/rl627/bchc_covid19_data/master/Clean/bchc_fips_xwalk.csv"
github_data_url = url("https://github.com/rl627/bchc_covid19_data/raw/master/Clean/bchc_cleaned_bundle.rdata")
load(github_data_url)
xwalk_bchc = fread(xwalk_url) %>% as_tibble() %>% 
  mutate(fips = str_pad(fips, width = 5, pad = "0")) %>% 
  filter(comparable == 1)

## Clean mask data
data_url = "https://raw.githubusercontent.com/nytimes/covid-19-data/master/mask-use/mask-use-by-county.csv"
raw_all = fread(data_url) %>% as_tibble() %>% 
  clean_names() %>% 
  mutate(fips = str_pad(countyfp , width = 5, pad = "0")) %>% 
  select(-countyfp) %>% 
  group_by(fips) %>% 
  summarise_at(vars(everything()),~mean(.x)) %>% 
  ungroup() %>% 
  arrange(desc(always))
raw = fread(data_url) %>% as_tibble() %>% 
  clean_names() %>% 
  mutate(fips = str_pad(countyfp , width = 5, pad = "0")) %>% 
  left_join(xwalk_bchc %>% select(fips, city = city_name)) %>% 
  select(-countyfp,-fips) %>% 
  filter(!is.na(city)) %>% 
  group_by(city) %>% 
  summarise_at(vars(everything()),~mean(.x)) %>% 
  ungroup() %>% 
  arrange(desc(always))
xwalk_param = tibble(group = c("never","rarely","sometimes","frequently","always"),
                     group_pct_of_time_masked = c(0,0.2,0.5,0.8,1))

raw_cleaned = raw %>% 
  select(City = city,
         Never  = never,
         Rarely = rarely, 
         Sometimes = sometimes, 
         Frequently = frequently, 
         Always = always)


dfa = raw %>%
  pivot_longer(-city,names_to = "group", values_to = "prop") %>% 
  mutate(n_of_1k = prop*1000) %>% 
  left_join(xwalk_param) %>% 
  mutate(expected_n_masked = n_of_1k*group_pct_of_time_masked)

df_expect_pct = dfa %>% 
  group_by(city) %>% 
  summarize(prob_masked = sum(expected_n_masked)/1000) %>% 
  ungroup() %>% 
  arrange(desc(prob_masked)) %>% 
  mutate(prob_all5_masked = prob_masked^5)


df_expect_all = raw_all %>%
  pivot_longer(-fips,names_to = "group", values_to = "prop") %>% 
  mutate(n_of_1k = prop*1000) %>% 
  left_join(xwalk_param) %>% 
  mutate(expected_n_masked = n_of_1k*group_pct_of_time_masked)%>% 
  group_by(fips) %>% 
  summarize(prob_masked = sum(expected_n_masked)/1000) %>% 
  ungroup() %>% 
  arrange(desc(prob_masked)) %>% 
  mutate(prob_all5_masked = prob_masked^5)


## Politcal Info
load("../util/xwalk_election.rdata")

xwalk_politics = df_city_aggregates %>% 
  filter(grouper=="2016 Presidential Results (State)") %>% 
  mutate(city = str_sub(loc,1,-1L-4)) %>% 
  select(city_name = city, group)
```

### Introduction

The World Health Organization and the U.S. Centers for Disease Control and Prevention recommend using face masks to slow the spread of the COVID-19 virus. However, face coverings have not been as widely adopted in the US during this current epidemic as it has in previous epidemic epidemics (1918 Influenza Pandemic) or as in other countries internationally. Data on face mask usage is limited but the global survey firm Dynata at the request of The New York Times conducted a relatively large scale 250,000 survey between July 2 and July 14 to provide county-level estimates of mask usage. The associated NYT article can be found [here](https://www.nytimes.com/interactive/2020/07/17/upshot/coronavirus-face-mask-map.html) and the data can be found [here](https://github.com/nytimes/covid-19-data/tree/master/mask-use). 

Although, the NYT has no further plans to update the data or conduct the survey again this survey provides a potential glimpse to mask usage at a sub-state level for at least two weeks in July. This post will use the Dynata mask usage data to not only compare the mask usage in BCHC cities but also to track association with longitudinal trends in COVID outcomes around the survey date. This visualization and analysis focus on the 15 BCHC cities for which we have good county-level proxies.

### Compare Estimated Mask Usage across BCHC cities (July 2 - 14)


![](/blog/2020-08-18-dynata-mask-wearing-survey-analysis-for-bchc-cities.en_files/legend_mask.PNG){ height=75px}

```{r map, echo=FALSE, fig.align="center", fig.height=4.5, fig.width=8, message=FALSE, warning=FALSE}
xwalk_spaces = raw_cleaned %>% 
  pivot_longer(-City, names_to = "group") %>% 
  select(group) %>% distinct() %>% 
  mutate(spaces = c(paste(rep("&nbsp;",11),collapse = ""),
                    paste(rep("&nbsp;",11),collapse = ""),
                    paste(rep("&nbsp;",3),collapse = ""),
                    paste(rep("&nbsp;",3),collapse = ""),
                    paste(rep("&nbsp;",9),collapse = "")
  ))

df_labs_tmp = raw_cleaned %>% 
  pivot_longer(-City, names_to = "group") %>% 
  rename(city = City) %>% 
  left_join(xwalk_spaces) %>% 
  mutate(value = round(value*100,0) %>% 
           paste( group,spaces,.,"%") ) %>% 
  group_by(city) %>% 
  summarise(label_raw = paste0(value, collapse = "<br/>")) %>% 
  ungroup() %>% 
  mutate(label_raw = paste(str_replace_all(str_wrap("How often do you wear a mask in public when you expect to be within six feet of another person?", width = 42),"\n","<br/>"),"<br/>",label_raw))


sf_tmp = st_as_sf(bchc_hex_sf) %>% 
  mutate(city = str_sub(loc,1,-1L-4)) %>% 
  left_join(df_expect_pct)  %>% 
  mutate(value  = paste(round(prob_all5_masked*100,0)))%>% 
  mutate(labs_raw2= str_replace_all(
    str_wrap(
      paste("This translates to a",
            paste(value,"%"),
            "that everyone is masked in five random encounters"), width = 42),"\n","<br/>") %>% 
      str_replace( paste(value,"%"),
                   paste("<strong>", paste(value,"%"),"</strong>")
      )
    
    
  ) %>% 
  left_join(df_labs_tmp) %>% 
  mutate(labs = ifelse(is.na(prob_masked),
                       paste0("<strong>",loc,"</strong>","<br/> ","County Proxy Not Available"),
                       paste0("<strong>",loc,"</strong><br/>",label_raw,"<br/> ",labs_raw2) ) 
  )

pal = leaflet::colorBin(palette = "RdPu",bins = 9,
                        domain = 0:1,
                        na.color = "#bdbdbd")
#bbox = c(-130, 20, -67,50)
bbox = c(-130, 10, -67,50)
sf_tmp %>% 
  leaflet(options = leafletOptions(
    attributionControl=FALSE,
    minZoom = 4, maxZoom = 4)
  ) %>% 
  addProviderTiles(
    providers$CartoDB.PositronNoLabels,
    options = providerTileOptions(noWrap = TRUE)
  ) %>% 
  addPolygons(weight = 1, 
              color = I("black"),
              label = ~purrr::map(labs,~HTML(.x)),
              fillOpacity = 1,
              fillColor = ~pal(prob_all5_masked),
              labelOptions = labelOptions(style = list(
                "font-size" = "13px"
              ))) %>% 
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4]) 

```


For the average BCHC city, there is a 58 % chance that all five people will be masked in a random encounter. Based on this metric, the cities with the lowest and highest mask usage are Indianapolis (33%) and Austin (71%).

Although these city-level estimates are interesting, they are also quite limiting. It is difficult to use the Dynata data to examine the effect of mask usage on preventing the spread of COVID19 because we only have a single time point for each city which critically ignores context: not only the stage of the epidemic in each city but also the past and previous mask usage trends. 

What we can do is to examine the effect of mandatory mask orders on the downstream COVID19 trends for each city. 

### Effect of Mask Mandates on COVID-19

Although mandatory mask order does not equal compliance, we can still examine the effect of this policy for each city. For 15 cities we plot daily new cases (7-day moving average), data of mandatory mask order, and 30-day trends for before the order and after the order. The cities are ordered by the magnitude of difference in slope between the after mandate 30-day trend and before mandate 30-day trend. 

```{r trends_norm, echo=FALSE, fig.height=6, fig.width=9, message=FALSE, warning=FALSE}

## Get Daily Data
dfa = df_daily %>% 
  filter(rate =="rate value") %>% 
  filter(type =="confirmed") %>% 
  filter(city_name%in%df_expect_pct$city) %>% 
  left_join(xwalk_politics) %>% 
  select(city_name,date, value) 

## Get mask mandate dates
df_mask = read_excel("../util/mask_order_dates.xlsx") %>% 
  mutate(date = as.Date(date_order)) %>% 
  select(city_name = city, date) %>% 
  left_join(dfa) %>% 
  select(city_name,date, value_at_order=value)


## Merge data and create 30 day before and after marker
 # .x =  dfa %>% 
 #  left_join(df_mask) %>% 
 #   filter(city_name == "Austin")
df_tmp =  dfa %>% 
  left_join(df_mask) %>% 
  group_by(city_name) %>% 
  group_modify(~{
    date_tmp = .x %>% 
      filter(!is.na(value_at_order)) %>% 
      pull(date)
    index_tmp = .x %>% 
      mutate(n = row_number()) %>% 
      filter(!is.na(value_at_order)) %>% 
      pull(n)
    length_tmp = length(.x$date)
    days_since_order_tmp =  c(rev(1:(index_tmp-1)),
                   0,
                   (1):(length_tmp-index_tmp))
    .x %>% 
      mutate(stage_days = case_when(
        date%in%seq(date_tmp-31, date_tmp-1, by = "day")~"before30",
        date%in%seq(date_tmp+1, date_tmp+31, by = "day")~"after30"
      )) %>% 
      mutate(days_since_order=days_since_order_tmp)
  }) %>% 
  ungroup()

## Get slopes for before and after at each city
df_effect =  df_tmp %>% 
  group_by(city_name) %>% 
  group_modify(~{
    df_modelData_tmp = tibble(
      days = 1:31,
      data_before= .x %>% 
        filter(stage_days == 'before30') %>% 
        pull(value),
      data_after = .x %>% 
        filter(stage_days == 'after30') %>% 
        pull(value) %>% c(.,rep(NA, 31-length(.)))
    ) 
    tibble(
      coef_before = lm(data =df_modelData_tmp, data_before~days) %>% 
        tidy() %>% filter(term == "days") %>% pull(estimate),
      coef_after = lm(data =df_modelData_tmp, data_after~days) %>% 
        tidy() %>% filter(term == "days") %>% pull(estimate)
    )
  }) %>% 
  mutate(coef_diff = coef_after-coef_before) %>% 
  arrange(coef_diff)

labels = df_effect %>% left_join(df_mask) %>% 
  mutate(labs = paste0(
    city_name
  ))
  # mutate(labs = paste0(
  #   city_name,"\n(Ordered ",format.Date(date,"%b, %d"),")"
  # ))

## Make Legend
df = mtcars %>% as_tibble() %>% 
  mutate(grp = as.character(rep(c("Daily New cases",
                                  "Mandatory Mask Order",
                                  "Before 30 day trend",
                                  "After 30 day trend"),8))) %>% 
  mutate(grp = factor(grp,
                      levels = c("Daily New cases",
                                  "Mandatory Mask Order",
                                  "Before 30 day trend",
                                  "After 30 day trend"))) %>% 
  select(grp, mpg, wt)

extract_legend <- function(my_ggp) {
  step1 <- ggplot_gtable(ggplot_build(my_ggp))
  step2 <- which(sapply(step1$grobs, function(x) x$name) == "guide-box")
  step3 <- step1$grobs[[step2]]
  return(step3)
}


plot_tmp = df %>% 
  ggplot(aes(x = mpg, y = wt, col = grp, lty = grp))+
  geom_line()+
  scale_linetype_manual(values = c(1,2,1,1))+
  scale_color_manual(values = c("black","black","red","green"))+
    theme_fivethirtyeight()+
  theme(legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank())
mask_order_legend = extract_legend(plot_tmp)

## Merge and plot
df2 = df_tmp
p = df2%>% 
  left_join(df_effect) %>% 
  mutate(city_name_f = factor(city_name,
                              labels = labels$labs,
                              levels =df_effect$city_name )) %>% 
  ggplot(aes(x=date, y=value))+
  geom_line()+
  geom_smooth(data = df_tmp %>% 
                filter(stage_days=="before30")%>% 
                mutate(city_name_f = factor(city_name,
                                            labels = labels$labs,
                                            levels =df_effect$city_name )),
              method = "lm", color = "red",se = F, size = 0.75)+
  geom_smooth(data = df_tmp %>% 
                filter(stage_days=="after30")%>% 
                mutate(city_name_f = factor(city_name,
                                            labels = labels$labs,
                                            levels =df_effect$city_name )),
              method = "lm", color = "green",se = F, size = 0.75)+
  geom_vline(data= df_mask %>% 
               mutate(city_name_f = factor(city_name,
                                           labels = labels$labs,
                                           levels =df_effect$city_name )),
             aes( xintercept =date), lty = 2)+
  facet_wrap(~city_name_f, scales = "free_y")+
  theme_fivethirtyeight()+
  theme(plot.margin=unit(c(3, 1, 0, 1), units="line"))


# cowplot::plot_grid(mask_order_legend,p, nrow = 2,
#                    rel_heights = c(0.1,0.9))

ggdraw()+
  draw_plot(p)+
  draw_grob(mask_order_legend, vjust  = -0.45)
```

New York City has the largest shift in trends of new COVID-19 cases associated with mandatory mask order. In almost all cities (Austin, Pheonix, San Antonio, Baltimore, Denver, Portland, and Washington), a characteristic shifts from increasing trends (positive slope) towards a decreasing trend (negative slope) is associated with mandatory mask policies. Outliers to this pattern are cities such as Philadelphia, San Francisco and Indianapolis are where mask policies are implemented after the city has peaked and new daily cases are relatively low. 

An interesting visualization we can no do is to rescale the x-axis to days since order. This will allow us to view the aggregate trend of BCHC cities in response to Mandatory Mask Orders.

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.height=3, fig.width=7}
dfa = df_daily %>% 
  filter(rate =="count value") %>% 
  filter(type =="confirmed") %>% 
  filter(city_name%in%df_expect_pct$city) %>% 
  left_join(xwalk_politics) %>% 
  select(city_name, pop,date, value) #%>% 
  #mutate(value = round((value/max(value))*100,2))

## Get mask mandate dates
df_mask = read_excel("../util/mask_order_dates.xlsx") %>% 
  mutate(date = as.Date(date_order)) %>% 
  select(city_name = city, date) %>% 
  left_join(dfa) %>% 
  select(city_name,date, value_at_order=value)


## Merge data and create 30 day before and after marker
 # .x =  dfa %>%
 #  left_join(df_mask) %>%
 #   filter(city_name == "Austin")
df_tmp =  dfa %>% 
  left_join(df_mask) %>% 
  group_by(city_name) %>% 
  group_modify(~{
    date_tmp = .x %>% 
      filter(!is.na(value_at_order)) %>% 
      pull(date)
    index_tmp = .x %>% 
      mutate(n = row_number()) %>% 
      filter(!is.na(value_at_order)) %>% 
      pull(n)
    length_tmp = length(.x$date)
    days_since_order_tmp =  c(rev(1:(index_tmp-1))*-1,
                   0,
                   (1):(length_tmp-index_tmp))
    .x %>% 
      select(-value_at_order) %>% 
      mutate(days_since_order=days_since_order_tmp)
  }) %>% 
  ungroup() 

tot.pop = df_tmp %>% select(city_name, pop) %>% distinct() %>% pull(pop) %>% sum()

df_tmp %>% 
  group_by(days_since_order) %>% 
  summarize(value = (sum(value)/tot.pop)*1000000) %>% 
  ungroup() %>% 
  ggplot(aes(x = days_since_order, y = value))+
  geom_line()+
  geom_vline(xintercept = 0, lty = 2)+
  theme_fivethirtyeight() + 
  theme(axis.title = element_text(size = "13px") ,
        plot.title = element_text(size = "17px") )+
  labs(x = "Days since order", y = "New cases per 1 M",
       title = "Aggregate trends of Daily New cases per capita for 15 BCHC Cities",
       subtitle = "Dotted line is day of mandatory mask order")
```

There is a clear association between the mask order and a decrease in trends of new daily cases. It is noted that this analysis ignores two critical aspects of policy interventions. Firstly, we did not account for other policy interventions such as social distancing measures so we cannot say that this effect is solely due to mask usage policy. Secondly, we do not have any information on longitudinal compliance to mandatory mask policies. A future post will continue to explore these other areas. 

## Methodology

### Dynata Dataset

We operationalized the survey data into 'Chance all five people are wearing masks in five random encounters' as reported in the initial NYT analysis: "The chance all five people are wearing masks in five random encounters is calculated by assuming that survey respondents who answered ‘Always’ were wearing masks all of the time, those who answered ‘Frequently’ were wearing masks 80 percent of the time, those who answered ‘Sometimes’ were wearing masks 50 percent of the time, those who answered ‘Rarely’ were wearing masks 20 percent of the time and those who answered ‘Never’ were wearing masks none of the time."

### Mandatory Mask Policies

The dates of the mandatory mask orders were obtained from the sources in the table below. In order to obtain the 30-day trend lines, we fit a linear model to daily new cases (7-day moving average) from the thirty days immediate either prior to or after an order was issued. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
library(kableExtra)
df_mask = read_excel("../util/mask_order_dates.xlsx") %>% 
  mutate(date = as.Date(date_order)) %>% 
  select(City = city, Date = date, Source =source)

df_mask %>% 
  kable()%>%
  column_spec(1, width = "10em")%>%
  column_spec(2, width = "10em")%>%
  column_spec(3, width = "50em")
```

